# Build stage for the frontend
FROM node:16-alpine as frontend-build
WORKDIR /app
COPY frontend/package*.json ./
RUN npm ci
COPY frontend/ ./
ARG REACT_APP_API_URL
ARG REACT_APP_STRIPE_PUBLIC_KEY
ENV REACT_APP_API_URL=$REACT_APP_API_URL
ENV REACT_APP_STRIPE_PUBLIC_KEY=$REACT_APP_STRIPE_PUBLIC_KEY
RUN npm run build

# Backend stage
FROM node:16-alpine
WORKDIR /app

# Copy backend package files
COPY backend/package*.json ./
RUN npm ci --production

# Copy backend code
COPY backend/ ./

# Copy frontend build
COPY --from=frontend-build /app/build ./public

# Set environment variables
ENV NODE_ENV=production

# Expose the port
EXPOSE 5000

# Run the application
CMD ["node", "index.js"]